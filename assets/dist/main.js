const h=jQuery,_=document;class b{static numberField=1;static numberTextarea=1;constructor(c,f,p,u,r){this.type=c,this.label=f,this.required=p,this.extras=u,this.editing=r,this.element=null}static inicializarNumerosMaximos(){const c=document.querySelectorAll("div[data-info-field]");let f=0,p=0;c.forEach(u=>{const r=u.getAttribute("data-info-field");if(r)try{const d=JSON.parse(r);for(const g in d)if(g.startsWith("field_")){const m=parseInt(g.split("_")[1]);!isNaN(m)&&m>f&&(f=m)}else if(g.startsWith("textarea_")){const m=parseInt(g.split("_")[1]);!isNaN(m)&&m>p&&(p=m)}}catch(d){console.error("Error al parsear JSON:",d,"en el div:",u)}}),b.numberField=f+1,b.numberTextarea=p+1}static CreateJSONField(c,f,p,u,r){const d={};return d[r]={type:c,label:f,required:p},Object.keys(u[0]).length>0&&(d[r].extras=u[0]||{}),JSON.stringify(d,null,0)}createField(){const c=_.createDocumentFragment(),f=_.createElement("div"),p=_.createElement("DIV"),u=_.createElement("button"),r=_.createElement("button");h(f).addClass("field-form"),h(f).attr("draggable","true"),h(p).addClass("form-field"),u.textContent="Editar",u.classList.add("btn-primary","btn-edit-field"),u.setAttribute("type","button"),r.textContent="Borrar",r.classList.add("btn-caution","btn-delete-field"),r.setAttribute("type","button");let d,g;this.editing||(this.type==="textarea"||this.type==="file"?(g=b.numberTextarea,b.numberTextarea++,d=`textarea_${g}`):(g=b.numberField,b.numberField++,d=`field_${g}`));let m;if(this.editing)h(p).html(`<div class="field-label">${this.label}</div><span class="field-type">${this.type}</span>`),d=h(".is-editing").data("fieldId"),m=b.CreateJSONField(this.type,this.label,this.required,this.extras,d),h(".is-editing").find(".field-label").html(this.label),h(".is-editing").find(".field-type").text(this.type),h(".is-editing").attr("data-info-field",m);else return m=b.CreateJSONField(this.type,this.label,this.required,this.extras,d),h(f).attr("data-info-field",m),h(f).attr("data-field-id",d),h(p).html(`<div class="field-label">${this.label}</div><span class="field-type">${this.type}</span>`),c.appendChild(p),c.append(u),c.append(r),f.append(c),f}}jQuery(function(e){const c=e("#form-generate-json"),f=e(".info-form"),p=e(".save-json-form");let u=tinyMCE.get("labelfield"),r=e("#type-field"),d=e("#required-field"),g=e("#class-field"),m=e(".default-select"),C=e('input[name="rules_validation"]'),D=e("#validate-date"),z=e(".wrapper-items-fields"),B=e(".textarea-value-default"),H=e(".textarea-cols"),Q=e(".textarea-rows"),A=e(".file-mimetypes"),G=e(".file-size"),M=e(".file-multiple"),S=e(".enable-tyc"),I=e(".btn-add-field"),T=e(".actions-edit-field"),F=e(".preview-form .fields-added"),K=e(".sidebar-settings-fields"),U=e(".btn-add-option"),k=e(".btn-add-checkradio");function V(a="",i=""){return`
    <div class="option-select option-radio option-checkbox option-field">
      <div>
        <label>Clave</label>
        <input type="text" placeholder="Dejar vacío para usar el valor" class="key-option" value="${a||""}">
      </div>
      <div>
        <label>Valor</label>
        <input type="text" class="value-option" value="${i||"Opción 1"}">
      </div>
      <button class="btn btn-caution">-</button>
    </div>
    `}function J(a){return a.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"")}function q(){u.setContent(""),r.val("text").trigger("change"),D.val("").trigger("change"),d.prop("checked",!1),g.val(""),M.prop("checked",!1),S.prop("checked",!1),k.show();for(let a=0;a<C.length;a++)e(C[a]).prop("checked",!1)}e(".btn-edit").on("click",function(a){T.removeClass("editing"),I.removeClass("no-show"),L(!0),q(),e(".field-form").removeClass("is-editing")}),e(T).find(".btn-cancel").on("click",function(){T.removeClass("editing"),e(".field-form").removeClass("is-editing"),I.removeClass("no-show"),q()}),I.on("click",function(){L()});function L(a=!1){const i=u.getContent(),l=r.val(),n=d[0].checked,t=g.val(),s={},v=m.val(),o=e(".extra-visible .option-field"),x=e(".enable-tyc")[0].checked,y=e(".file-mimetypes").val(),ie=e(".file-size").val()?e(".file-size").val():2,ae=e(".file-multiple")[0].checked,le=e(".textarea-value-default").val(),se=e(".textarea-rows").val()?e(".textarea-rows").val():3,ne=e(".textarea-cols").val()?e(".textarea-cols").val():8,P={},E=[];if(o.length>0&&e(o).each(function(w,j){let O=e(j).find(".key-option").val(),W=e(j).find(".value-option").val();O===""?O=J(W):O=O,P[O]=W,s.options=P}),l==="text"){for(let w=0;w<C.length;w++)C[w].checked&&E.push(C[w].value);E.length>0&&(s.validation_rules=E)}if(l==="select"&&(s.select_default=v),l==="file"&&(s.accept=y,s.max_size=ie,s.multiple=ae),l==="checkbox"&&(s.is_tos=x),l==="textarea"&&(s.value=le,s.rows=se,s.cols=ne),l==="date"&&(D.val()!==""&&E.push(D.val()),s.validation_rules=E),t!==""&&(s.div_class=t),u.getContent().trim()!==""?e("#wp-labelfield-wrap").closest(".basic-field").removeClass("no-empty"):e("#wp-labelfield-wrap").closest(".basic-field").addClass("no-empty"),y==""?A.closest("p").addClass("no-empty"):A.closest("p").removeClass("no-empty"),i!==""&&y!==""){e(K).removeClass("visible-settings");const j=new b(l,i,n,[s],a).createField();F.append(j),q()}}e(r).on("change",function(a){let i=e(a.target).val();e('[class^="options-"]').html(""),e(".extra").removeClass("extra-visible"),e(`.extra-${i}`).addClass("extra-visible")}),S.on("change",function(){this.checked?(z.html(""),k.hide()):k.show()});function X(){e(U).on("click",function(){e(".options-select").append(V())}),e(k).on("click",function(){e(".options-checkbox-radio").append(V())})}function Y(){e("body").on("click",".btn-caution",function(a){e(this).parent().remove()})}function Z(){e("body").click(function(a){if(e(a.target).hasClass("btn-edit-field")){const i=e(a.target).closest(".field-form"),l=e(i).data("infoField");e(i).removeData("infoField"),T.addClass("editing"),I.addClass("no-show"),e(".field-form").removeClass("is-editing"),e(i).addClass("is-editing");for(const n in l)if(l.hasOwnProperty(n)){const t=l[n];if(r.val(t.type).trigger("change"),u.setContent(t.label),d.prop("checked",t.required),t.extras){const s=t.extras.options;if(t.type==="select"||t.type==="checkbox"||t.type==="radio"){m.val(t.extras.select_default),S.prop("checked",t.extras.is_tos),t.extras.is_tos&&k.hide();for(const v in s)if(s.hasOwnProperty(v)){const o=s[v];e(".extra-visible").find(z).append(V(v,o))}}if(t.type==="text"){const v=t.extras.validation_rules;v&&Array.isArray(v)&&v.forEach(o=>{C.each((x,y)=>{if(y.value===o)return e(y).prop("checked",!0),!1})})}if(t.type==="textarea"&&(B.val(t.extras.value),H.val(t.extras.cols),Q.val(t.extras.rows)),t.type==="file"&&(A.val(t.extras.accept),G.val(t.extras.max_size),M.prop("checked",t.extras.multiple)),t.type==="date"){const v=t.extras.validation_rules;D.val(v[0]).trigger("change")}g.val(t.extras.div_class)}}}})}function $(){let a=null;F.on("dragstart",".field-form",function(i){e(this).addClass("dragging"),i.originalEvent.dataTransfer.setData("text/plain",e(this).index()),a=e(this).clone().css({position:"absolute",top:"0",width:e(this).outerWidth(),height:e(this).outerHeight(),opacity:.8,pointerEvents:"none",zIndex:1e3,border:"1px solid #a0c4ff",backgroundColor:"#f1f2f5",borderRadius:"10px",boxShadow:"0 2px 3px 0 rgba(0,0,0,0.2)"}).appendTo("body"),setTimeout(()=>e(this).css("opacity","0"),0);let l=e(this).clone().css({width:e(this).outerWidth(),height:e(this).outerHeight(),position:"relative",opacity:1,pointerEvents:"none"})[0];i.originalEvent.dataTransfer.setDragImage(l,0,0),i.originalEvent.dataTransfer.setDragImage(new Image,0,0)}),F.on("dragover",function(i){i.preventDefault(),e(this).addClass("dragover")}),F.on("dragleave",function(i){e(this).removeClass("dragover")}),F.on("drop",function(i){i.preventDefault();let l=i.originalEvent.dataTransfer.getData("text/plain"),n=e(this).find(".field-form").eq(l),t=e(i.target).closest(".field-form");if(t.length&&n[0]!==t[0]){let s=t.index();l<s?t.after(n):t.before(n)}e(".field-form").removeClass("dragging"),e(this).removeClass("dragover")}),F.on("dragend",".field-form",function(){e(this).removeClass("dragging"),e(this).css("opacity","1").removeClass("dragging"),a&&(a.remove(),a=null)}),e(document).on("drag",function(i){a&&a.css({top:i.originalEvent.pageY+5+"px",left:i.originalEvent.pageX+5+"px"})})}function R(a){let i=!0;for(let l=0;l<a.length;l++){const n=a[l];e(n).val()===""?(e(n).closest("div").addClass("no-empty"),i=!1):e(n).closest("div").removeClass("no-empty")}return i}function ee(a){let i=!1;const l=a;function n(){i=!0}l.find('input[type="text"], input[type="email"], input[type="checkbox"]').on("change input",n);const t=new MutationObserver(function(o){o.forEach(function(x){x.addedNodes.forEach(function(y){e(y).is("div.field-form")&&(e(y).find("input, select, textarea").on("change input",n),i=!0)})})}),s=e(".fields-added")[0],v={childList:!0,subtree:!0};t.observe(s,v),e(".fields-added").on("click",".btn-edit-field, .btn-delete-field",function(){i=!0}),e("#title-form").on("change input",n),e(window).on("beforeunload",function(o){if(i){o.preventDefault();const x="¿Seguro que quieres salir sin guardar los cambios?";return o.returnValue=x,x}}),e(p).on("click",function(){R(f)&&(i=!1)})}let te=[];const N=e("#simpleforms-edit-form-id").val()||null;p.on("click",a=>{a.preventDefault();const i=c.find(".title-form").val();c.find(".emails-form").val(),c.find(".label-button").val();const l=c.find(".fields-added .field-form").toArray(),n=N||J(i);if(!N&&te.some(o=>o.id===n)){alert(`El formulario con ID "${n}" ya existe.`);return}let t={};l.forEach(o=>{let x=e(o).data("infoField");t=Object.assign({},t,x)});const s={id:n,version:1,fields:t,settings:{titulo:i}};R(f)&&(c.attr("data-json-form",JSON.stringify(s)),e.ajax({url:ajaxurl,method:"POST",data:{action:"simpleforms_save_form",form:s,is_edit:N?1:0},success:function(o){console.log("Guardado OK",o),alert("Formulario guardado correctamente."),window.location.reload()},error:function(o){console.error("Error al guardar:",o),alert("Error al guardar el formulario")}}))}),r.val("text").trigger("change"),b.inicializarNumerosMaximos(),$(),Y(),X(),Z(),ee(c)});
