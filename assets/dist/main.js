const b=jQuery,w=document;class x{static numberField=1;static numberTextarea=1;constructor(s,d,m,c,o){this.type=s,this.label=d,this.required=m,this.extras=c,this.editing=o,this.element=null}static inicializarNumerosMaximos(){const s=document.querySelectorAll("div[data-info-field]");let d=0,m=0;s.forEach(c=>{const o=c.getAttribute("data-info-field");if(o)try{const g=JSON.parse(o);for(const y in g)if(y.startsWith("field_")){const f=parseInt(y.split("_")[1]);!isNaN(f)&&f>d&&(d=f)}else if(y.startsWith("textarea_")){const f=parseInt(y.split("_")[1]);!isNaN(f)&&f>m&&(m=f)}}catch(g){console.error("Error al parsear JSON:",g,"en el div:",c)}}),x.numberField=d+1,x.numberTextarea=m+1}static CreateJSONField(s,d,m,c,o){const g={};return g[o]={type:s,label:d,required:m},Object.keys(c[0]).length>0&&(g[o].extras=c[0]||{}),JSON.stringify(g,null,0)}createField(){const s=w.createDocumentFragment(),d=w.createElement("div"),m=w.createElement("DIV"),c=w.createElement("button"),o=w.createElement("button"),g=w.createElement("img"),y=w.createElement("img");b(d).addClass("field-form"),b(d).attr("draggable","true"),b(m).addClass("form-field"),c.textContent="Editar",c.classList.add("btn-primary","btn-edit-field"),c.setAttribute("type","button"),o.textContent="Borrar",o.classList.add("btn-caution","btn-delete-field"),o.setAttribute("type","button");let f,h;this.editing||(this.type==="textarea"||this.type==="file"?(h=x.numberTextarea,x.numberTextarea++,f=`textarea_${h}`):(h=x.numberField,x.numberField++,f=`field_${h}`));let C;if(this.editing)b(m).html(`<div class="field-label">${this.label}</div><span class="field-type">${this.type}</span>`),f=b(".is-editing").data("fieldId"),C=x.CreateJSONField(this.type,this.label,this.required,this.extras,f),b(".is-editing").find(".field-label").html(this.label),b(".is-editing").find(".field-type").text(this.type),b(".is-editing").attr("data-info-field",C);else return C=x.CreateJSONField(this.type,this.label,this.required,this.extras,f),b(d).attr("data-info-field",C),b(d).attr("data-field-id",f),b(m).html(`<div class="field-label">${this.label}</div><span class="field-type">${this.type}</span>`),s.appendChild(m),s.append(c),s.append(o),s.append(g),s.append(y),d.append(s),d}}jQuery(function(e){const s=e("#form-generate-json"),d=e(".info-form"),m=e(".save-json-form");let c=tinyMCE.get("labelfield"),o=e("#type-field"),g=e("#required-field"),y=e("#class-field"),f=e(".default-select"),h=e('input[name="rules_validation"]'),C=e("#validate-date"),M=e(".wrapper-items-fields"),H=e(".textarea-value-default"),Q=e(".textarea-cols"),G=e(".textarea-rows"),A=e(".file-mimetypes"),K=e(".file-size"),J=e(".file-multiple"),S=e(".enable-tyc"),T=e(".btn-add-field"),I=e(".actions-edit-field"),k=e(".preview-form .fields-added"),U=e(".sidebar-settings-fields"),X=e(".btn-add-option"),_=e(".btn-add-checkradio");function V(a="",i=""){return`
    <div class="option-select option-radio option-checkbox option-field">
      <div>
        <label>Clave</label>
        <input type="text" placeholder="Dejar vacío para usar el valor" class="key-option" value="${a||""}">
      </div>
      <div>
        <label>Valor</label>
        <input type="text" class="value-option" value="${i||"Opción 1"}">
      </div>
      <button class="btn btn-caution">-</button>
    </div>
    `}function L(a){return a.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim().toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_]/g,"")}function q(){c.setContent(""),o.val("text").trigger("change"),C.val("").trigger("change"),g.prop("checked",!1),y.val(""),J.prop("checked",!1),S.prop("checked",!1),_.show();for(let a=0;a<h.length;a++)e(h[a]).prop("checked",!1)}e(".btn-edit").on("click",function(a){I.removeClass("editing"),T.removeClass("no-show"),P(!0),q(),e(".field-form").removeClass("is-editing")}),e(I).find(".btn-cancel").on("click",function(){I.removeClass("editing"),e(".field-form").removeClass("is-editing"),T.removeClass("no-show"),q()}),T.on("click",function(){P()});function P(a=!1){const i=c.getContent(),n=o.val(),r=g[0].checked,t=y.val(),l={},u=f.val(),v=e(".extra-visible .option-field"),F=e(".enable-tyc")[0].checked,p=e(".file-mimetypes").val(),z=e(".file-size").val()?e(".file-size").val():2,ae=e(".file-multiple")[0].checked,le=e(".textarea-value-default").val(),ne=e(".textarea-rows").val()?e(".textarea-rows").val():3,se=e(".textarea-cols").val()?e(".textarea-cols").val():8,W={},O=[];if(v.length>0&&e(v).each(function(E,j){let D=e(j).find(".key-option").val(),B=e(j).find(".value-option").val();D===""?D=L(B):D=D,W[D]=B,l.options=W}),n==="text"){for(let E=0;E<h.length;E++)h[E].checked&&O.push(h[E].value);O.length>0&&(l.validation_rules=O)}if(n==="select"&&(l.select_default=u),n==="file"&&(l.accept=p,l.max_size=z,l.multiple=ae),n==="checkbox"&&(l.is_tos=F),n==="textarea"&&(l.value=le,l.rows=ne,l.cols=se),n==="date"&&(C.val()!==""&&O.push(C.val()),l.validation_rules=O),t!==""&&(l.div_class=t),c.getContent().trim()!==""?e("#wp-labelfield-wrap").closest(".basic-field").removeClass("no-empty"):e("#wp-labelfield-wrap").closest(".basic-field").addClass("no-empty"),p==""?A.closest("p").addClass("no-empty"):A.closest("p").removeClass("no-empty"),i!==""&&p!==""){e(U).removeClass("visible-settings");const j=new x(n,i,r,[l],a).createField();k.append(j),q()}}e(o).on("change",function(a){let i=e(a.target).val();e('[class^="options-"]').html(""),e(".extra").removeClass("extra-visible"),e(`.extra-${i}`).addClass("extra-visible")}),S.on("change",function(){this.checked?(M.html(""),_.hide()):_.show()});function Y(){e(X).on("click",function(){e(".options-select").append(V())}),e(_).on("click",function(){e(".options-checkbox-radio").append(V())})}function Z(){e("body").on("click",".btn-caution",function(a){e(this).parent().remove()})}function $(){e("body").click(function(a){if(e(a.target).hasClass("btn-edit-field")){const i=e(a.target).closest(".field-form"),n=e(i).data("infoField");e(i).removeData("infoField"),I.addClass("editing"),T.addClass("no-show"),e(".field-form").removeClass("is-editing"),e(i).addClass("is-editing");for(const r in n)if(n.hasOwnProperty(r)){const t=n[r];if(o.val(t.type).trigger("change"),c.setContent(t.label),g.prop("checked",t.required),t.extras){const l=t.extras.options;if(t.type==="select"||t.type==="checkbox"||t.type==="radio"){f.val(t.extras.select_default),S.prop("checked",t.extras.is_tos),t.extras.is_tos&&_.hide();for(const u in l)if(l.hasOwnProperty(u)){const v=l[u];e(".extra-visible").find(M).append(V(u,v))}}if(t.type==="text"){const u=t.extras.validation_rules;u&&Array.isArray(u)&&u.forEach(v=>{h.each((F,p)=>{if(p.value===v)return e(p).prop("checked",!0),!1})})}if(t.type==="textarea"&&(H.val(t.extras.value),Q.val(t.extras.cols),G.val(t.extras.rows)),t.type==="file"&&(A.val(t.extras.accept),K.val(t.extras.max_size),J.prop("checked",t.extras.multiple)),t.type==="date"){const u=t.extras.validation_rules;C.val(u[0]).trigger("change")}y.val(t.extras.div_class)}}}})}function ee(){let a=null;k.on("dragstart",".field-form",function(i){e(this).addClass("dragging"),i.originalEvent.dataTransfer.setData("text/plain",e(this).index()),a=e(this).clone().css({position:"absolute",top:"0",width:e(this).outerWidth(),height:e(this).outerHeight(),opacity:.8,pointerEvents:"none",zIndex:1e3,border:"1px solid #a0c4ff",backgroundColor:"#f1f2f5",borderRadius:"10px",boxShadow:"0 2px 3px 0 rgba(0,0,0,0.2)"}).appendTo("body"),setTimeout(()=>e(this).css("opacity","0"),0);let n=e(this).clone().css({width:e(this).outerWidth(),height:e(this).outerHeight(),position:"relative",opacity:1,pointerEvents:"none"})[0];i.originalEvent.dataTransfer.setDragImage(n,0,0),i.originalEvent.dataTransfer.setDragImage(new Image,0,0)}),k.on("dragover",function(i){i.preventDefault(),e(this).addClass("dragover")}),k.on("dragleave",function(i){e(this).removeClass("dragover")}),k.on("drop",function(i){i.preventDefault();let n=i.originalEvent.dataTransfer.getData("text/plain"),r=e(this).find(".field-form").eq(n),t=e(i.target).closest(".field-form");if(t.length&&r[0]!==t[0]){let l=t.index();n<l?t.after(r):t.before(r)}e(".field-form").removeClass("dragging"),e(this).removeClass("dragover")}),k.on("dragend",".field-form",function(){e(this).removeClass("dragging"),e(this).css("opacity","1").removeClass("dragging"),a&&(a.remove(),a=null)}),e(document).on("drag",function(i){a&&a.css({top:i.originalEvent.pageY+5+"px",left:i.originalEvent.pageX+5+"px"})})}function R(a){let i=!0;for(let n=0;n<a.length;n++){const r=a[n];e(r).val()===""?(e(r).closest("div").addClass("no-empty"),i=!1):e(r).closest("div").removeClass("no-empty")}return i}function te(a){let i=!1;const n=a;function r(){i=!0}n.find('input[type="text"], input[type="email"], input[type="checkbox"]').on("change input",r);const t=new MutationObserver(function(v){v.forEach(function(F){F.addedNodes.forEach(function(p){e(p).is("div.field-form")&&(e(p).find("input, select, textarea").on("change input",r),i=!0)})})}),l=e(".fields-added")[0],u={childList:!0,subtree:!0};t.observe(l,u),e(".fields-added").on("click",".btn-edit-field, .btn-delete-field",function(){i=!0}),e("#title-form").on("change input",r),e(window).on("beforeunload",function(v){if(i){v.preventDefault();const F="¿Seguro que quieres salir sin guardar los cambios?";return v.returnValue=F,F}}),e(m).on("click",function(){R(d)&&(i=!1)})}let ie=[];const N=e("#simpleforms-edit-form-id").val()||null;m.on("click",a=>{a.preventDefault();const i=s.find(".title-form").val(),n=s.find(".emails-form").val(),r=s.find(".label-button").val(),t=s.find(".fields-added .field-form").toArray(),l=N||L(i);if(!N&&ie.some(p=>p.id===l)){alert(`El formulario con ID "${l}" ya existe.`);return}let u={};t.forEach(p=>{let z=e(p).data("infoField");u=Object.assign({},u,z)});const v={id:l,version:1,fields:u,submit_btn:{submit_type:"send",label:r},settings:{titulo:i,email_list:n}};R(d)&&(s.attr("data-json-form",JSON.stringify(v)),e.ajax({url:ajaxurl,method:"POST",data:{action:"simpleforms_save_form",form:v,is_edit:N?1:0},success:function(p){console.log("Guardado OK",p),alert("Formulario guardado correctamente."),window.location.reload()},error:function(p){console.error("Error al guardar:",p),alert("Error al guardar el formulario")}}))}),o.val("text").trigger("change"),x.inicializarNumerosMaximos(),ee(),Z(),Y(),$(),te(s)});
